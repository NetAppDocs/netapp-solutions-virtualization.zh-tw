---
sidebar: sidebar 
permalink: proxmox/proxmox-ontap.html 
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, ontap, storage, aff 
summary: 'Proxmox 虛擬環境 (VE) 中的共享儲存減少了 VM 即時遷移的時間，並為整個環境中的備份和一致模板提供了更好的目標。  ONTAP儲存可以滿足 Proxmox VE 主機環境以及客戶文件、區塊和物件儲存需求。' 
---
= 為 Proxmox 虛擬環境配置ONTAP存儲
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
使用 NAS、SAN 和 SMB/CIFS 協定透過 Proxmox 虛擬環境 (VE) 配置ONTAP儲存。  Proxmox VE 中的共享儲存減少了即時 VM 遷移的時間，並為整個環境中的備份和一致模板提供了更好的目標。

Proxmox VE 主機需要將 FC、乙太網路或其他支援的介面連接到交換機，並與ONTAP邏輯介面進行通訊。始終檢查 https://mysupport.netapp.com/matrix/#welcome["互通性矩陣工具"]了解支援的配置。



== 進階ONTAP功能

*共同特徵*

* 擴展集群
* 安全性身份驗證和 RBAC 支持
* 零信任多管理員支持
* 安全多租戶
* 使用SnapMirror複製資料。
* 使用快照進行時間點複製。
* 節省空間的克隆。
* 儲存效率功能，如重複資料刪除、壓縮等。
* Trident CSI 對 Kubernetes 的支持
* Snaplock
* 防篡改快照副本鎖定
* 加密支援
* FabricPool將冷資料分層到物件儲存。
* NetApp Console和Data Infrastructure Insights整合。
* Microsoft 卸載資料傳輸 (ODX)


*NAS*

* FlexGroup磁碟區是一個橫向擴充 NAS 容器，提供高效能以及負載分配和可擴充性。
* FlexCache允許資料在全球分發，同時仍提供對資料的本地讀寫存取。
* 多重協定支援使得相同的資料可以透過 SMB 和 NFS 存取。
* NFS nConnect 允許每個 TCP 連線建立多個 TCP 會話，從而增加網路吞吐量。這增加了現代伺服器上可用的高速網路卡的使用率。
* NFS 會話中繼提供了更高的資料傳輸速度、高可用性和容錯能力。
* SMB 多通道提供了更高的資料傳輸速度、高可用性和容錯能力。
* 與 Active Directory/LDAP 整合以取得檔案權限。
* 透過 TLS 與 NFS 建立安全連線。
* NFS Kerberos 支援。
* 透過 RDMA 實現的 NFS。
* Windows 與 Unix 身分之間的名稱對應。
* 自主勒索軟體保護。
* 文件系統分析。


*SAN*

* 使用SnapMirror主動同步跨故障域擴展叢集。務必檢查 https://mysupport.netapp.com/matrix/#welcome["互通性矩陣工具"] 適用於支援的配置。
* ASA模型提供主動/主動多路徑和快速路徑故障轉移。
* 支援FC、iSCSI、NVMe-oF協定。
* 支援 iSCSI CHAP 相互認證。
* 選擇性 LUN 對映和連接埠集。




== ONTAP支援的 Proxmox VE 儲存類型

NAS 協定（NFS/SMB）支援 Proxmox VE 的所有內容類型，並且通常在資料中心層級配置一次。客戶虛擬機器可以使用 NAS 儲存上的 raw、qcow2 或 VMDK 類型的磁碟。 ONTAP快照可見，以便從客戶端存取資料的時間點副本。採用 SAN 協定（FC/iSCSI/NVMe-oF）的區塊儲存通常按主機配置，並且僅限於 Proxmox VE 支援的 VM 磁碟和容器映像內容類型。客戶虛擬機器和容器將區塊儲存作為原始設備使用。

[cols="25% 15% 15% 15% 15% 15%"]
|===
| 內容類型 | NFS | 中小企業/CIFS | FC | iSCSI | NVMe-oF 


| 備份 | 是的 | 是的  a| 
否^1^
 a| 
否^1^
 a| 
否^1^



| 虛擬機器磁碟 | 是的 | 是的  a| 
是的^2^
 a| 
是的^2^
 a| 
是的^2^



| CT體積 | 是的 | 是的  a| 
是的^2^
 a| 
是的^2^
 a| 
是的^2^



| ISO 映像 | 是的 | 是的  a| 
否^1^
 a| 
否^1^
 a| 
否^1^



| CT模板 | 是的 | 是的  a| 
否^1^
 a| 
否^1^
 a| 
否^1^



| 片段 | 是的 | 是的  a| 
否^1^
 a| 
否^1^
 a| 
否^1^

|===
*註：* 1 - 需要叢集檔案系統來建立共用資料夾並使用目錄儲存類型。  2——使用 LVM 儲存類型。



== SMB/CIFS存儲

要利用 SMB/CIFS 檔案共享，儲存管理員需要執行某些任務，虛擬化管理員可以使用 Proxmox VE UI 或從 shell 掛載共享。 SMB 多通道提供容錯功能並提高效能。有關詳細信息，請參閱link:https://www.netapp.com/pdf.html?item=/media/17136-tr4740.pdf["TR4740 - SMB 3.0 多通道"]


NOTE: 密碼將保存在明文文件中，只有 root 使用者可以存取。請參閱link:https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_cifs["Proxmox VE 文檔"] 。

.採用ONTAP 的SMB 共享儲存池
video::5b4ae54a-08d2-4f7d-95ec-b22d015f6035[panopto,width=360]
.<strong>儲存管理任務</strong>
[%collapsible%open]
====
如果是ONTAP新手，請使用系統管理員介面完成這些任務以獲得更好的體驗。

. 確保 SVM 已啟用 SMB。跟隨link:https://docs.netapp.com/us-en/ontap/smb-config/configure-access-svm-task.html["ONTAP 9 文件"]了解更多。
. 每個控制器至少有兩個生命。請按照上述連結中的步驟操作。作為參考，這是此解決方案中使用的 lifs 的螢幕截圖。
+
image:proxmox-ontap-001.png["nas接口詳細信息"]

. 使用基於 Active Directory 或工作組的身份驗證。請按照上述連結中的步驟操作。
+
image:proxmox-ontap-002.png["加入網域資訊"]

. 建立卷。請記得選取跨叢集分發資料的選項以使用FlexGroup。
+
image:proxmox-ontap-023.png["FlexGroup選項"]

. 建立 SMB 共享並調整權限。跟隨link:https://docs.netapp.com/us-en/ontap/smb-config/configure-client-access-shared-storage-concept.html["ONTAP 9 文件"]了解更多。
+
image:proxmox-ontap-003.png["SMB 共享資訊"]

. 向虛擬化管理員提供 SMB 伺服器、共享名稱和憑證，以便他們完成任務。


====
.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 收集用於共享身份驗證的 SMB 伺服器、共享名稱和憑證。
. 確保至少兩個介面配置在不同的 VLAN 中（以實現容錯）並且 NIC 支援 RSS。
. 如果使用管理 UI `https:<proxmox-node>:8006` ，點選資料中心，選擇存儲，點選新增，選擇SMB/CIFS。
+
image:proxmox-ontap-004.png["SMB儲存導航"]

. 填寫詳細信息，共享名稱將自動填入。確保選擇了所有內容。按一下“新增”。
+
image:proxmox-ontap-005.png["SMB 儲存新增"]

. 若要啟用多通道選項，請前往叢集中任意一個節點上的 shell，然後鍵入 pvesm set pvesmb01 --options multichannel,max_channels=4
+
image:proxmox-ontap-006.png["多通道設定"]

. 以下是 /etc/pve/storage.cfg 中針對上述任務的內容。
+
image:proxmox-ontap-007.png["SMB 的儲存設定檔"]



====


== NFS 存儲

ONTAP支援 Proxmox VE 支援的所有 NFS 版本。為了提供容錯和性能增強，確保link:https://docs.netapp.com/us-en/ontap/nfs-trunking/index.html["會話中繼"]被利用。要使用會話中繼，至少需要 NFS v4.1。

如果是ONTAP新手，請使用系統管理員介面完成這些任務以獲得更好的體驗。

.ONTAP的 NFS nconnect 選項
video::f6c9aba3-b070-45d6-8048-b22e001acfd4[panopto,width=360]
.<strong>儲存管理任務</strong>
[%collapsible%open]
====
. 確保 SVM 已啟用 NFS。請參閱link:https://docs.netapp.com/us-en/ontap/nfs-config/verify-protocol-enabled-svm-task.html["ONTAP 9 文件"]
. 每個控制器至少有兩個生命。請按照上述連結中的步驟操作。作為參考，這是我們在實驗室中使用的 lifs 的螢幕截圖。
+
image:proxmox-ontap-001.png["nas接口詳細信息"]

. 建立或更新 NFS 匯出策略，提供對 Proxmox VE 主機 IP 位址或子網路的存取。參考link:https://docs.netapp.com/us-en/ontap/nfs-config/create-export-policy-task.html["出口政策制定"]和link:https://docs.netapp.com/us-en/ontap/nfs-config/add-rule-export-policy-task.html["在匯出策略中新增規則"]。
. link:https://docs.netapp.com/us-en/ontap/nfs-config/create-volume-task.html["創建卷"] 。請記得選取跨叢集分發資料的選項以使用FlexGroup。
+
image:proxmox-ontap-023.png["FlexGroup選項"]

. link:https://docs.netapp.com/us-en/ontap/nfs-config/associate-export-policy-flexvol-task.html["為磁碟區分配導出策略"]
+
image:proxmox-ontap-008.png["NFS 磁碟區資訊"]

. 通知虛擬化管理員 NFS 磁碟區已準備就緒。


====
.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 確保至少兩個介面配置在不同的 VLAN 中（以實現容錯）。使用 NIC 綁定。
. 如果使用管理 UI `https:<proxmox-node>:8006` ，點擊資料中心，選擇存儲，點擊添加，選擇NFS。
+
image:proxmox-ontap-009.png["NFS儲存導航"]

. 填寫詳細信息，提供伺服器資訊後，NFS 匯出應填充並從清單中選擇。記得選擇內容選項。
+
image:proxmox-ontap-010.png["NFS 儲存添加"]

. 若要啟用 nConnect 選項，請在叢集中的任一節點上進入 shell，然後輸入 pvesm set pvenfs01 --options nconnect=4，其中 pvenfs01 是上一個步驟建立的儲存 ID。請注意，如果您打算使用連結聚合功能，請確保使用至少 NFS v4.1 版本，並設定 trunkdiscovery 選項。 pvesm set pvenfs01 --options vers=4.1,trunkdiscovery


====


== 帶有 iSCSI 的 LVM

.使用ONTAP 的iSCSI LVM 共享池
video::d66ef67f-bcc2-4ced-848e-b22e01588e8c[panopto,width=360]
若要為 Proxmox 主機之間的共用儲存配置邏輯磁碟區管理器，請完成下列任務：

.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 確保有兩個 Linux Vlan 介面可用。
. 確保所有 Proxmox VE 主機上都安裝了多路徑工具。確保它在啟動時啟動。
+
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools
systemctl enable multipathd
----
. 收集所有 Proxmox VE 主機的 iscsi 主機 iqn 並將其提供給儲存管理員。
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----


====
.<strong>儲存管理任務</strong>
[%collapsible%open]
====
如果是ONTAP新手，請使用系統管理員以獲得更好的體驗。

. 確保 SVM 可用且啟用了 iSCSI 協定。跟隨link:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["ONTAP 9 文件"]
. 每個控制器有兩個專用於 iSCSI 的 lif。
+
image:proxmox-ontap-013.png["iSCSI介面詳細信息"]

. 建立 igroup 並填入主機 iscsi 啟動器。
. 在 SVM 上建立具有所需大小的 LUN，並將其呈現給上述步驟中建立的 igroup。
+
image:proxmox-ontap-014.png["iscsi lun 詳細信息"]

. 通知虛擬化管理員 lun 已建立。


====
.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 進入管理介面 `https:<proxmox node>:8006`，點擊資料中心，選擇存儲，點擊添加，選擇iSCSI。
+
image:proxmox-ontap-015.png["iscsi儲存導航"]

. 提供儲存 ID 名稱。當沒有通訊問題時， ONTAP的 iSCSI lif 位址應該能夠選擇目標。由於我們的目的不是直接向來賓虛擬機器提供 LUN 訪問，因此請取消選取該選項。
+
image:proxmox-ontap-016.png["iscsi儲存類型創建"]

. 現在，按一下新增並選擇 LVM。
+
image:proxmox-ontap-017.png["lvm儲存導航"]

. 提供儲存 ID 名稱，選擇與我們在上一個步驟中建立的 iSCSI 儲存相符的基本儲存。選擇基本卷的 LUN。提供卷宗組名稱。確保已選擇共享。
+
image:proxmox-ontap-018.png["lvm儲存創建"]

. 這是使用 iSCSI 磁碟區的 LVM 的範例儲存設定檔。
+
image:proxmox-ontap-019.png["lvm iscsi配置"]



====


== 帶有 NVMe/TCP 的 LVM

.使用ONTAP 的具有 NVMe/TCP 的 LVM 共用池
video::80164fe4-06db-4c21-a25d-b22e0179c3d2[panopto,width=360]
若要為 Proxmox 主機之間的共用儲存配置邏輯磁碟區管理器，請完成下列任務：

.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 確保有兩個 Linux Vlan 介面可用。
. 在叢集上的每個 Proxmox 主機上，執行下列命令來收集主機啟動器資訊。
+
[source, shell]
----
nvme show-hostnqn
----
. 向儲存管理員提供收集到的主機 nqn 資訊並請求所需大小的 nvme 命名空間。


====
.<strong>儲存管理任務</strong>
[%collapsible%open]
====
如果是ONTAP新手，請使用系統管理員以獲得更好的體驗。

. 確保 SVM 可用且啟用了 NVMe 協定。參考link:https://docs.netapp.com/us-en/ontap/san-admin/create-nvme-namespace-subsystem-task.html["ONTAP 9 上的 NVMe 任務文檔"]。
. 建立 NVMe 命名空間。
+
image:proxmox-ontap-020.png["nvme 命名空間創建"]

. 建立子系統並指派主機 nqns（如果使用 CLI）。按照上面的參考連結。
. 通知虛擬化管理員 nvme 命名空間已建立。


====
.<strong>虛擬化管理任務</strong>
[%collapsible%open]
====
. 導航到叢集中每個 Proxmox VE 主機上的 shell 並建立 /etc/nvme/discovery.conf 檔案並更新特定於您的環境的內容。
+
[source, shell]
----
root@pxmox01:~# cat /etc/nvme/discovery.conf
# Used for extracting default parameters for discovery
#
# Example:
# --transport=<trtype> --traddr=<traddr> --trsvcid=<trsvcid> --host-traddr=<host-traddr> --host-iface=<host-iface>

-t tcp -l 1800 -a 172.21.118.153
-t tcp -l 1800 -a 172.21.118.154
-t tcp -l 1800 -a 172.21.119.153
-t tcp -l 1800 -a 172.21.119.154
----
. 登入 nvme 子系統
+
[source, shell]
----
nvme connect-all
----
. 檢查並收集設備詳細資料。
+
[source, shell]
----
nvme list
nvme netapp ontapdevices
nvme list-subsys
lsblk -l
----
. 建立卷宗組
+
[source, shell]
----
vgcreate pvens02 /dev/mapper/<device id>
----
. 進入管理介面 `https:<proxmox node>:8006`，點選資料中心，選擇存儲，點選新增，選擇LVM。
+
image:proxmox-ontap-017.png["lvm儲存導航"]

. 提供儲存 ID 名稱，選擇現有磁碟區組並選擇剛剛使用 cli 建立的磁碟區組。記得檢查共享選項。
+
image:proxmox-ontap-021.png["現有 vg 上的 lvm"]

. 這是使用 NVMe/TCP 的 LVM 的範例儲存設定檔
+
image:proxmox-ontap-022.png["NVM 上的 LVM TCP 配置"]



====