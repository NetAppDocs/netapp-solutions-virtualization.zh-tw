---
sidebar: sidebar 
permalink: vmware/vmw-disaster-recovery-vmfs.html 
keywords: dr, draas, bluexp, disaster recovery, vmfs datastore 
summary: 本文檔的此部分介紹了BlueXP DRaaS 的配置，以便為本地 VMware VM 設定災難復原到另一個指定站點。 
---
= 使用BlueXP disaster recovery
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
在此用例中，我們概述了使用BlueXP disaster recovery為使用 VMware 虛擬機器檔案系統 (VMFS) 資料儲存的本機 VMware VM 設定災難復原的過程。此過程包括設定BlueXP帳戶和連接器、在ONTAP系統之間建立SnapMirror複製、與 VMware vCenter 整合以及自動執行故障轉移和故障復原作業。

使用從生產站點到災難復原站點的區塊級複製進行災難復原是一種有彈性且經濟高效的方法，可保護工作負載免受網站中斷和資料損壞事件（如勒索軟體攻擊）的影響。透過NetApp SnapMirror複製，使用 VMFS 資料儲存區運行本地ONTAP系統的 VMware 工作負載可以複製到 VMware 所在的指定復原資料中心的另一個ONTAP儲存系統



== 介紹

本文檔的此部分介紹了BlueXP DRaaS 的配置，以便為本地 VMware VM 設定災難復原到另一個指定站點。作為此設定的一部分， BlueXP帳戶、 BlueXP連接器、 BlueXP工作區內新增的ONTAP陣列是實現從 VMware vCenter 到ONTAP儲存的通訊所必需的。此外，本文檔詳細介紹如何設定網站之間的複製以及如何設定和測試復原計畫。最後一部分介紹如何執行完整網站故障轉移以及在主網站恢復並在線上購買後如何進行故障復原。

使用整合到NetApp BlueXP控制台中的BlueXP disaster recovery服務，客戶可以發現其內部部署的 VMware vCenter 以及ONTAP儲存、建立資源群組、建立災難復原計畫、將其與資源群組關聯，以及測試或執行故障轉移和故障復原。SnapMirror提供儲存層級區塊複製，使兩個網站保持最新的增量更改，使 RPO 達到最長 5 分鐘。也可以將 DR 流程模擬為常規演習，而不會影響生產和複製的資料儲存或產生額外的儲存成本。BlueXP disaster recovery利用 ONTAP 的FlexClone技術，從 DR 站點上最後複製的快照建立 VMFS 資料儲存區的節省空間的副本。一旦 DR 測試完成，客戶就可以簡單地刪除測試環境，而不會對實際複製的生產資源產生任何影響。當需要（計劃內或計劃外）進行實際故障轉移時，只需單擊幾下， BlueXP disaster recovery服務就會協調所需的所有步驟，自動在指定的災難復原站點上啟動受保護的虛擬機器。該服務還將逆轉與主站點的SnapMirror關係，並在需要時將任何變更從輔助站點複製到主站點以進行故障恢復操作。與其他知名替代方案相比，所有這些都只需花費極少的成本即可實現。

image:dr-draas-vmfs-030.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 入門

若要開始使用BlueXP disaster recovery，請使用BlueXP控制台，然後存取服務。

. 登入BlueXP。
. 從BlueXP左側導覽中，選擇保護 > 災難復原。
. 出現BlueXP disaster recovery儀表板。


image:dr-draas-vmfs-001.png["此圖顯示輸入/輸出對話框或表示書面內容"]

在配置災難復原計畫之前，請確保滿足以下先決條件：

* BlueXP Connector 在NetApp BlueXP中設定。連接器應部署在 AWS VPC 中。
* BlueXP連接器執行個體與來源和目標 vCenter 和儲存系統具有連線。
* BlueXP中新增了為 VMware 託管 VMFS 資料儲存區的本機NetApp儲存系統。
* 使用 DNS 名稱時應該進行 DNS 解析。否則，請使用 vCenter 的 IP 位址。
* SnapMirror複製是為指定的基於 VMFS 的資料儲存磁碟區配置的。


一旦來源站點和目標站點之間建立連接，請繼續執行設定步驟，這大約需要 3 到 5 分鐘。


NOTE: NetApp建議在災難復原站點或第三個站點部署BlueXP連接器，以便BlueXP連接器可以在實際中斷或自然災害期間透過網路與來源資源和目標資源進行通訊。

image:dr-draas-vmfs-002.png["此圖顯示輸入/輸出對話框或表示書面內容"]


NOTE: 在撰寫本文檔時，對本地到本機 VMFS 資料儲存的支援處於技術預覽階段。基於 FC 和 ISCSI 協定的 VMFS 資料儲存均支援此功能。



== BlueXP disaster recovery配置

準備災難復原的第一步是發現並將內部部署 vCenter 和儲存資源新增至BlueXP disaster recovery。


NOTE: 確保ONTAP儲存系統已新增至畫布內的工作環境。開啟BlueXP控制台並從左側導覽中選擇 *保護 > 災難復原*。選擇*發現 vCenter 伺服器*或使用頂部選單，選擇*網站 > 新增 > 新增 vCenter*。

image:dr-draas-vmfs-003.png["此圖顯示輸入/輸出對話框或表示書面內容"]

新增以下平台：

* *來源*。本機 vCenter。


image:dr-draas-vmfs-004.png["此圖顯示輸入/輸出對話框或表示書面內容"]

* *目的地*。VMC SDDC vCenter。


image:dr-draas-vmfs-005.png["此圖顯示輸入/輸出對話框或表示書面內容"]

一旦新增了 vCenter，就會觸發自動發現。



== 配置來源站點和目標站點之間的儲存複製

SnapMirror利用ONTAP快照來管理從一個位置到另一個位置的資料傳輸。首先，基於來源磁碟區快照的完整副本被複製到目標位置以執行基線同步。當來源處發生資料變更時，會建立一個新的快照並將其與基準快照進行比較。然後將發現已更改的區塊複製到目標位置，其中較新的快照成為當前基線或最新的公共快照。這使得該過程可以重複，並且可以將增量更新發送到目的地。

建立SnapMirror關係後，目標磁碟區處於線上唯讀狀態，因此仍可存取。SnapMirror與實體儲存區塊一起工作，而不是在檔案或其他邏輯層級上工作。這意味著目標磁碟區是來源的相同副本，包括快照、磁碟區設定等。如果來源磁碟區正在使用ONTAP空間效率功能（例如資料壓縮和重複資料刪除），則複製的磁碟區將保留這些最佳化。

中斷SnapMirror關係會使目標磁碟區變得可寫，並且通常在使用SnapMirror將資料同步到 DR 環境時用於執行故障轉移。SnapMirror足夠複雜，可以允許故障轉移網站上更改的資料有效地重新同步回主系統（如果主系統稍後恢復上線），然後允許重新建立原始的SnapMirror關係。



== 如何設定 VMware 災難復原

對於任何給定的應用程序，創建SnapMirror複製的過程都是相同的。過程可以是手動的，也可以是自動的。最簡單的方法是利用BlueXP配置SnapMirror複製，只需將環境中的來源ONTAP系統拖曳到目標上即可觸發指導其餘流程的精靈。

image:dr-draas-vmfs-006.png["此圖顯示輸入/輸出對話框或表示書面內容"]

如果滿足以下兩個條件， BlueXP DRaaS 也可以自動執行相同的操作：

* 源集群和目標集群具有對等關係。
* 源 SVM 和目標 SVM 具有對等關係。


image:dr-draas-vmfs-007.png["此圖顯示輸入/輸出對話框或表示書面內容"]


NOTE: 如果已經透過 CLI 為磁碟區配置了SnapMirror關係， BlueXP DRaaS 將取得該關係並繼續其餘工作流程操作。


NOTE: 除了上述方法之外，還可以透過ONTAP CLI 或系統管理器建立SnapMirror複製。無論使用SnapMirror同步資料的方法是什麼， BlueXP DRaaS 都會協調工作流程，實現無縫、高效的災難復原作業。



== BlueXP disaster recovery能為您做什麼？

在新增來源站點和目標站點後， BlueXP disaster recovery將執行自動深度發現並顯示虛擬機器及其相關元資料。BlueXP disaster recovery也會自動偵測虛擬機器使用的網路和連接埠群組並填入它們。

image:dr-draas-vmfs-008.png["此圖顯示輸入/輸出對話框或表示書面內容"]

新增網站後，虛擬機器可以分組到資源組。BlueXP disaster recovery資源群組可讓您將一組依賴的虛擬機器分組為邏輯群組，這些邏輯群組包含可在復原時執行的啟動順序和啟動延遲。若要開始建立資源組，請導覽至*資源組*並點選*建立新資源組*。

image:dr-draas-vmfs-009.png["此圖顯示輸入/輸出對話框或表示書面內容"]


NOTE: 在建立複製計劃時也可以建立資源組。

可以透過簡單的拖放機制在建立資源群組期間定義或修改虛擬機器的啟動順序。

image:dr-draas-vmfs-010.png["此圖顯示輸入/輸出對話框或表示書面內容"]

建立資源群組後，下一步是建立執行藍圖或在災難發生時復原虛擬機器和應用程式的計畫。如先決條件中所述，可以預先配置SnapMirror複製，或者 DRaaS 可以使用在建立複製計劃期間指定的 RPO 和保留計數來配置它。

image:dr-draas-vmfs-011.png["此圖顯示輸入/輸出對話框或表示書面內容"]

image:dr-draas-vmfs-012.png["此圖顯示輸入/輸出對話框或表示書面內容"]

透過從下拉式選單中選擇來源和目標 vCenter 平台來設定複製計劃，並選擇要包含在計劃中的資源群組，以及如何復原和啟動應用程式的分組以及叢集和網路的對應。若要定義復原計劃，請導覽至「*複製計劃*」標籤並按一下「*新增計劃*」。

首先，選擇來源 vCenter，然後選擇目標 vCenter。

image:dr-draas-vmfs-013.png["此圖顯示輸入/輸出對話框或表示書面內容"]

下一步是選擇現有的資源組。如果沒有建立資源組，則精靈將協助根據復原目標對所需的虛擬機器進行分組（基本上建立功能資源組）。這也有助於定義如何恢復應用程式虛擬機器的操作順序。

image:dr-draas-vmfs-014.png["此圖顯示輸入/輸出對話框或表示書面內容"]


NOTE: 資源組允許使用拖放功能設定啟動順序。它可用於輕鬆修改復原過程中虛擬機器的啟動順序。


NOTE: 資源組內的各個虛擬機器依序依序啟動。兩個資源組並行啟動。

如果未事先建立資源群組，則下列螢幕截圖顯示了根據組織要求過濾虛擬機器或特定資料儲存的選項。

image:dr-draas-vmfs-015.png["此圖顯示輸入/輸出對話框或表示書面內容"]

選擇資源組後，建立故障轉移對映。在此步驟中，指定來源環境中的資源如何對應到目標。這包括運算資源、虛擬網路。IP 自訂、前腳本和後腳本、啟動延遲、應用程式一致性等。有關詳細信息，請參閱link:https://docs.netapp.com/us-en/bluexp-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["建立複製計劃"]。

image:dr-draas-vmfs-016.png["此圖顯示輸入/輸出對話框或表示書面內容"]


NOTE: 預設情況下，測試和故障轉移操作使用相同的映射參數。若要對測試環境套用不同的映射，請取消選取複選框後選擇測試映射選項，如下所示：

image:dr-draas-vmfs-017.png["此圖顯示輸入/輸出對話框或表示書面內容"]

資源映射完成後，按一下下一步。

image:dr-draas-vmfs-018.png["此圖顯示輸入/輸出對話框或表示書面內容"]

選擇重複類型。簡單來說，選擇遷移（使用故障轉移的一次性遷移）或重複連續複製選項。在本演練中，選擇了「複製」選項。

image:dr-draas-vmfs-019.png["此圖顯示輸入/輸出對話框或表示書面內容"]

完成後，檢查建立的映射，然後按一下新增計劃。

image:dr-draas-vmfs-020.png["此圖顯示輸入/輸出對話框或表示書面內容"]

image:dr-draas-vmfs-021.png["此圖顯示輸入/輸出對話框或表示書面內容"]

建立複製計劃後，可以根據需求透過選擇故障轉移選項、測試故障轉移選項或遷移選項來執行故障轉移。BlueXP disaster recovery確保每 30 分鐘按照計畫執行複製程序。在故障轉移和測試故障轉移選項期間，您可以使用最新的SnapMirror Snapshot 副本，也可以從時間點 Snapshot 副本中選擇特定的 Snapshot 副本（根據SnapMirror的保留策略）。如果發生勒索軟體等損壞事件，其中最新的副本已被破壞或加密，則時間點選項會非常有用。BlueXP disaster recovery顯示所有可用的復原點。

image:dr-draas-vmfs-022.png["此圖顯示輸入/輸出對話框或表示書面內容"]

若要使用複製計畫中指定的配置觸發故障轉移或測試故障轉移，請按一下「*故障轉移*」或「*測試故障轉移*」。

image:dr-draas-vmfs-023.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 故障轉移或測試故障轉移操作期間會發生什麼？

在測試故障轉移作業期間， BlueXP disaster recovery使用最新的 Snapshot 副本或目標磁碟區的選取快照在目標ONTAP儲存系統上建立FlexClone區。


NOTE: 測試故障轉移操作會在目標ONTAP儲存系統上建立複製磁碟區。


NOTE: 執行測試恢復操作不會影響SnapMirror複製。

image:dr-draas-vmfs-024.png["此圖顯示輸入/輸出對話框或表示書面內容"]

在此過程中， BlueXP disaster recovery不會對應原始目標磁碟區。相反，它會根據選定的快照建立一個新的FlexClone區，並將支援該FlexClone磁碟區的暫存資料儲存對應到 ESXi 主機。

image:dr-draas-vmfs-025.png["此圖顯示輸入/輸出對話框或表示書面內容"]

image:dr-draas-vmfs-026.png["此圖顯示輸入/輸出對話框或表示書面內容"]

當測試故障轉移操作完成時，可以使用「清理故障轉移測試」觸發清理操作。在此操作期間， BlueXP disaster recovery會破壞操作中使用的FlexClone磁碟區。

當真正的災難事件發生時， BlueXP disaster recovery將執行以下步驟：

. 中斷站點之間的SnapMirror關係。
. 重新簽署後掛載 VMFS 資料儲存磁碟區以供立即使用。
. 註冊虛擬機
. 啟動虛擬機


image:dr-draas-vmfs-027.png["此圖顯示輸入/輸出對話框或表示書面內容"]

一旦主網站啟動並運行， BlueXP disaster recovery就會啟用SnapMirror的反向重新同步並啟用故障恢復，這些操作只需點擊按鈕即可執行。

image:dr-draas-vmfs-028.png["此圖顯示輸入/輸出對話框或表示書面內容"]

如果選擇遷移選項，則它將被視為計劃內的故障轉移事件。在這種情況下，將觸發額外的步驟，即關閉來源站點的虛擬機器。其餘步驟與故障轉移事件相同。

從BlueXP或ONTAP CLI，您可以監控對應資料儲存磁碟區的複製健康狀態，並且可以透過作業監控追蹤故障轉移或測試故障轉移的狀態。

image:dr-draas-vmfs-029.png["此圖顯示輸入/輸出對話框或表示書面內容"]

這為處理量身定制的災難復原計劃提供了強大的解決方案。當發生災難並決定啟動 DR 站點時，可以按計劃進行故障轉移或單擊按鈕進行故障轉移。

要了解有關此過程的更多信息，請隨意觀看詳細的演示視頻或使用link:https://netapp.github.io/bluexp-draas-vmfs-simulator/?frame-0.1["解決方案模擬器"]。
