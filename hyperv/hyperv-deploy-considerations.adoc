---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-considerations.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, consideration 
summary: 該解決方案提供了在NetApp儲存上部署 Hyper-V 所需的步驟 
---
= 適用於 Microsoft Hyper-V 和ONTAP儲存系統的部署指南
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
為了確保在使用ONTAP儲存部署 Microsoft Hyper-V 時獲得最佳效能和可靠性，請考慮工作負載相容性、儲存大小和 VM 資源分配等因素。相容性檢查應包括作業系統版本、應用程式、資料庫和任何現有定制，以確保在 Hyper-V 環境中順利運行。



== 正確調整儲存大小

在部署工作負載或從現有虛擬機器管理程式遷移之前，請確保工作負載的大小能夠滿足所需的效能。這可以透過收集每個單獨的 VM 的效能資料輕鬆完成，這些資料收集 CPU（已使用/已配置）、記憶體（已使用/已配置）、儲存（已配置/已利用）、網路吞吐量和延遲的統計資料以及讀取/寫入 IOP、吞吐量和區塊大小的聚合。這些參數對於成功部署以及正確確定儲存陣列和工作負載主機的大小是必要的。

*注意*：在為 Hyper-V 和相關工作負載調整儲存大小時，請規劃 IOPS 和容量。

*注意*：對於 I/O 密集型虛擬機或需要大量資源和容量的虛擬機，請分離作業系統和資料磁碟。作業系統和應用程式二進位檔案很少更改，而且磁碟區崩潰一致性是可以接受的。

*注意*：使用來賓連接儲存（又稱來賓內）來獲得高效能資料磁碟，而不是使用 VHD。這也有助於簡化克隆過程。



== 增強虛擬機器效能

選擇適當數量的 RAM 和 vCPU 以獲得最佳效能，並將多個磁碟連接到單一虛擬 SCSI 控制器。仍建議使用固定 VHDx 作為部署虛擬磁碟的主要選擇，並且對使用任何類型的 VHDX 虛擬磁碟沒有任何限制。

*注意*：避免在 Windows Server 上安裝不需要的角色。

*注意*：選擇 Gen2 作為能夠從 SCSI 控制器載入 VM 的虛擬機器的代數，並且基於 VMBUS 和 VSP / VSC 架構作為啟動級別，這顯著提高了整體 VM 效能。

*注意*：避免頻繁進行檢查點，因為這會對虛擬機器的效能產生負面影響。



== SMB3.0的設計與考量

SMB 3.0 檔案共用可用作 Hyper-V 的共用儲存。 ONTAPONTAP透過 SMB 共用為 Hyper-V 進行無中斷操作。 Hyper-V 可以使用 SMB 文件共用來儲存虛擬機器文件，例如設定、快照和虛擬硬碟 (VHD) 文件。使用專用ONTAP CIFS SVM 為 Hyper-V 提供基於 SMB3.0 的共用。用於儲存虛擬機器檔案的磁碟區必須使用 NTFS 安全模式磁碟區建立。如果有 10GB 網絡，建議使用 10GB 網路建立 Hyper-V 主機與NetApp陣列之間的連接。對於 1GB 網路連接， NetApp建議建立一個由多個 1GB 連接埠組成的介面群組。將每個為 SMB 多通道提供服務的 NIC 連接到其專用 IP 子網，以便每個子網路在用戶端和伺服器之間提供單一路徑。

*要點*

* 在ONTAP SVM 上啟用 SMB 多通道
* ONTAP CIFS SVM 在叢集中的每個節點上應至少有一個資料 LIF。
* 所使用的共用必須配置持續可用的屬性集。
* ONTAP One 現在包含在每個AFF （A 系列和 C 系列）、全 SAN 陣列 (ASA) 和FAS系統中。因此不需要單獨的許可證。
* 對於共用 VHDx，使用來賓連線的 iSCSI LUN


*注意*：ODX 受支援並可跨協定工作。在檔案共用和 iSCSI 或 FCP 連線的 LUN 之間複製資料也利用 ODX。

*注意*：叢集中節點的時間設定應相應設定。如果NetApp CIFS 伺服器必須參與 Windows Active Directory (AD) 網域，則應使用網路時間協定 (NTP)。

*注意*：必須透過 CIFS 伺服器啟用較大的 MTU 值。較小的資料包可能會導致效能下降。



== 配置 SMB 卷

. 驗證儲存虛擬機器 (SVM) 上是否啟用了所需的 CIFS 伺服器選項
. 以下選項應設為 true：smb2-enabled、smb3-enabled、copy-offload-enabled、shadowcopy-enabled、is-multichannel-enabled、is-large-mtu-enabled
+
image:hyperv-deploy-003.png["SMB 列設定影像"]

. 在儲存虛擬機器 (SVM) 上建立 NTFS 資料卷，然後配置持續可用的共用以供 Hyper-V 使用
+
image:hyperv-deploy-004.png["NTFS 資料卷設定影像"]

+
*注意*：除非配置中使用的磁碟區建立為 NTFS 安全樣式捲，否則 Hyper-V 透過 SMB 的無中斷操作無法正常運作。

. 啟用持續可用性並在共用上配置 NTFS 權限以包含具有完全控制權的 Hyper-V 節點。
+
image:hyperv-deploy-005.png["NTFS 權限設定的圖片"]



有關詳細的最佳做法指導，請參閱link:https://docs.netapp.com/us-en/ontap-apps-dbs/microsoft/win_overview.html["Hyper-V 的部署指南和最佳實踐"]。

有關更多信息，請參閱link:https://docs.netapp.com/us-en/ontap/smb-hyper-v-sql/server-volume-requirements-hyper-v-concept.html["Hyper-V over SMB 的 SMB 伺服器和磁碟區要求"]。



== 區塊協議設計與考量

*要點*

* 在主機上使用多路徑（MPIO）來管理多條路徑。根據需要建立更多路徑，以促進資料移動操作或利用額外的 I/O 資源，但不要超過主機作業系統可以支援的最大路徑數。
* 在存取 LUN 的主機上安裝主機實用程式工具包。
* 至少創建 8 個磁碟區。


*注意*：每個磁碟區使用一個 LUN，因此 LUN 與 CSV 的對應比率為 1:1。

* SVM 應該在每個要使用 iSCSI 或光纖通道提供資料的儲存控制器上為每個乙太網路或光纖通道結構配備一個 LIF。
* 使用 FCP 或 iSCSI 提供資料的 SVM 需要 SVM 管理介面。




== 配置 ISCSI 卷

若要設定 ISCSI 卷，請確保滿足以下先決條件。

* 儲存虛擬機器 (SVM) 應啟用 iSCSI 協定並建立適當的邏輯介面 (LIF)。
* 指定的聚合必須具有足夠的可用空間來包含 LUN。


*註*：預設情況下， ONTAP使用選擇性 LUN 對應 (SLM) 使 LUN 只能透過擁有該 LUN 的節點及其高可用性 (HA) 夥伴節點上的路徑存取。

* 在每個節點上配置所有 iSCSI LIF 以實現 LUN 移動性，以防 LUN 移動到叢集中的另一個節點。


*步驟*

. 使用系統管理員並導航至 LUN 視窗（ONTAP CLI 可用於相同操作）。
. 按一下“建立”。
. 瀏覽並選擇要建立 LUN 的指定 SVM，然後顯示建立 LUN 精靈。
. 在「常規屬性」頁面上，為包含 Hyper-V 虛擬機器的虛擬硬碟 (VHD) 的 LUN 選擇 Hyper-V。
+
image:hyperv-deploy-006.png["Hyper-V LUN 建立的常規屬性頁面影像"]

. <按一下更多選項> 在 LUN 容器頁面上，選擇一個現有的FlexVol volume，否則將建立一個新磁碟區。
. <按一下更多選項> 在啟動器對映頁面上，按一下新增啟動器群組，在常規標籤上輸入所需信息，然後在啟動器標籤上輸入主機的 iSCSI 啟動器節點名稱。
. 確認詳細信息，然後按一下「完成」以完成精靈。


建立 LUN 後，前往故障轉移群集管理器。若要將磁碟新增至 CSV，必須先將該磁碟新增至叢集的可用儲存群組（如果尚未新增），然後將該磁碟新增至叢集上的 CSV。

*注意*：故障轉移群集中預設啟用 CSV 功能。

*將磁碟新增至可用儲存空間：*

. 在故障轉移群集管理員的控制台樹狀圖中，展開群集的名稱，然後展開「儲存」。
. 右鍵單擊“磁碟”，然後選擇“新增磁碟”。出現一個列表，顯示可以新增用於故障轉移群集的磁碟。
. 選擇要新增的一個或多個磁碟，然後選擇「確定」。
. 磁碟現已指派給可用儲存群組。
. 完成後，選擇剛剛指派給可用儲存的磁碟，並右鍵單擊選擇，然後選擇新增至叢集共用磁碟區。
+
image:hyperv-deploy-007.png["新增到集群共享卷介面的圖像"]

. 磁碟現已指派給叢集中的叢集共用磁碟區組。磁碟會作為 %SystemDrive%ClusterStorage 資料夾下的編號磁碟區（掛載點）向每個叢集節點公開。這些磁碟區出現在 CSVFS 檔案系統中。


有關更多信息，請參閱link:https://learn.microsoft.com/en-us/windows-server/failover-clustering/failover-cluster-csvs#add-a-disk-to-csv-on-a-failover-cluster["在故障轉移群集中使用群集共享卷"]。

建立高可用性虛擬機器：

若要建立高可用性虛擬機，請依照下列步驟操作：

. 在故障轉移群集管理員中，選擇或指定所需的群集。確保叢集下的控制台樹已展開。
. 單擊角色。
. 在“操作”窗格中，按一下“虛擬機器”，然後按一下“新虛擬機器”。出現新的虛擬機器精靈。按一下“下一步”。
. 在指定名稱和位置頁面上，指定虛擬機器的名稱，例如 nimdemo。按一下將虛擬機器儲存在其他位置，然後鍵入完整路徑或按一下瀏覽並導航至共用儲存。
. 為與實體網路適配器關聯的虛擬交換器分配記憶體並配置網路適配器。
. 在「連接虛擬硬碟」頁面上，按一下「建立虛擬硬碟」。
. 在「安裝選項」頁面上，按一下從啟動 CD/DVD-ROM 安裝作業系統。在「媒體」下，指定媒體的位置，然後按一下「完成」。
. 虛擬機器已建立。然後，故障轉移群集管理器中的高可用性精靈會自動配置虛擬機器以實現高可用性。




== 使用 ODX 功能快速配置虛擬磁碟

ONTAP中的 ODX 功能可透過簡單地複製ONTAP儲存系統所託管的主 VHDX 檔案來製作主 VHDX 的副本。由於支援 ODX 的副本不會將任何資料放在網路上，因此複製過程發生在NetApp儲存端，因此速度可提高六到八倍。快速配置的一般考慮包括儲存在檔案共用上的主系統準備映像和由 Hyper-V 主機啟動的常規複製過程。

*注意*： ONTAP支援 SMB 和 SAN 協定的 ODX。

*注意*：要利用 Hyper-V 的 ODX 複製卸載直通用例，來賓作業系統必須支援 ODX，且來賓作業系統的磁碟必須是由支援 ODX 的儲存（SMB 或 SAN）支援的 SCSI 磁碟。客戶作業系統上的 IDE 磁碟不支援 ODX 直通。



== 效能最佳化

雖然每個 CSV 的建議虛擬機器數量是主觀的，但有許多因素決定了可以放置在每個 CSV 或 SMB 磁碟區上的虛擬機器的最佳數量。儘管大多數管理員只考慮容量，但發送到 VHDx 的並發 I/O 量是整體效能的最關鍵因素之一。控制效能最簡單的方法是調節每個 CSV 或共用上放置的虛擬機器的數量。如果並發虛擬機器 I/O 模式向 CSV 或共用發送過多流量，則磁碟佇列將被填滿，並產生更高的延遲。



== SMB 捲和 CSV 大小

確保解決方案端到端大小足夠以避免瓶頸，並且在為 Hyper-V VM 儲存目的建立磁碟區時，最佳做法是建立不大於所需大小的磁碟區。正確調整磁碟區大小可防止意外在 CSV 上放置過多的虛擬機，並降低資源爭用的可能性。每個叢集共用磁碟區 (CSV) 支援一個或多個 VM。放置在 CSV 上的虛擬機器數量取決於工作負載和業務偏好，以及如何使用ONTAP儲存功能（例如快照和複製）。在大多數部署場景中，將多個虛擬機器放置在 CSV 上是一個很好的起點。針對具體用例調整此方法以滿足效能和資料保護要求。

由於磁碟區和 VHDx 大小可以輕鬆增加，因此如果 VM 需要額外的容量，則無需將 CSV 的大小設定得大於所需。 Diskpart 可用於擴展 CSV 大小，或更簡單的方法是建立一個新的 CSV 並將所需的 VM 遷移到新的 CSV。為了獲得最佳效能，最佳做法是增加 CSV 的數量，而不是增加其大小作為臨時措施。



== 遷移

在當前市場條件下最常見的用例之一是遷移。客戶可以使用 VMM Fabric 或其他第三方遷移工具來遷移虛擬機器。這些工具使用主機級複製將資料從來源平台移動到目標平台，這可能會很耗時，具體取決於遷移範圍內的虛擬機器數量。

在這種情況下使用ONTAP可以比使用基於主機的遷移過程實現更快的遷移。 ONTAP也支援虛擬機器從一個虛擬機器管理程式快速遷移到另一個虛擬機器管理程式（在本例中為 ESXi 到 Hyper-V）。在NetApp Storage 上，任何大小的 VMDK 都可以在幾秒鐘內轉換為 VHDx。這就是我們的 PowerShell 方式 - 它利用NetApp FlexClone技術快速轉換 VM 硬碟。它還處理目標和目標虛擬機器的建立和配置。

此流程有助於最大限度地減少停機時間並提高業務生產力。它還透過降低許可成本、鎖定和對單一供應商的承諾來提供選擇和靈活性。對於希望優化 VM 授權成本和擴展 IT 預算的組織來說，這也大有裨益。

以下影片示範了將虛擬機器從 VMware ESX 遷移到 Hyper-V 的過程。

.從 ESX 到 Hyper-V 的零接觸遷移
video::f4bd0e96-9517-465a-be53-b16d00e305fe[panopto]
有關使用 Flexclone 和 PowerShell 進行遷移的更多信息，請參閱link:hyperv-deploy-script.html["用於遷移的 PowerShell 腳本"]。
